<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ja" xml:lang="ja">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="description" content="Japan Perl Association CPAN和訳ドキュメント">
<meta name="keyword" content="perl,cpan,jpa,和訳,日本語訳">
<title>Moose::Cookbook::Basics::Recipe10 Moose(0.79) - Japan Perl Association ドキュメント和訳プロジェクト</title>
<link rel="stylesheet" type="text/css" href="http://lazy-css.org/css/style.css" />
</head>
<body>
<h1>Moose::Cookbook::Basics::Recipe10</h1>
<div class="path" id="path"><a href="/">HOME</a> &gt; <strong>Moose::Cookbook::Basics::Recipe10</strong></div><div class="pod">
<!-- INDEX START -->

<ul class="list-index"><li><a href="#">題名</a></li>
<li><a href="#-2">概要</a></li>
<li><a href="#-3">本文</a></li>
<li><a href="#-4">検討課題</a></li>
<li><a href="#-5">まとめ</a></li>
<li><a href="#-6">作者</a></li>
<li><a href="#COPYRIGHT_AND_LICENSE">COPYRIGHT AND LICENSE</a>
</li>
</ul><!-- INDEX END -->

<h2 id="">題名</h2>
<div id="CONTENT">
<p>Moose::Cookbook::Basics::Recipe10 - BUILDARGSとBUILDを使ってオブジェクトの生成に割り込む</p>

</div>
<h2 id="-2">概要</h2>
<div id="CONTENT-2">
<pre>  package Person;

  has 'ssn' =&gt; (
      is        =&gt; 'ro',
      isa       =&gt; 'Str',
      predicate =&gt; 'has_ssn',
  );

  has 'country_of_residence' =&gt; (
      is      =&gt; 'ro',
      isa     =&gt; 'Str',
      default =&gt; 'usa'
  );

  has 'first_name' =&gt; (
      is  =&gt; 'ro',
      isa =&gt; 'Str',
  );

  has 'last_name' =&gt; (
      is  =&gt; 'ro',
      isa =&gt; 'Str',
  );

  sub BUILDARGS {
      my $class = shift;

      if ( @_ == 1 &amp;&amp; ! ref $_[0] ) {
          return { ssn =&gt; $_[0] };
      }
      else {
          return $class-&gt;SUPER::BUILDARGS(@_);
      }
  }

  sub BUILD {
      my $self = shift;

      if ( $self-&gt;country_of_residence eq 'usa' ) {
          die 'Cannot create a Person who lives in the USA without an ssn.'
              unless $self-&gt;has_ssn;
      }
  }

</pre>

</div>
<h2 id="-3">本文</h2>
<div id="CONTENT-3">
<p>このレシピでは<code>BUILDARGS</code>と<code>BUILD</code>の使い方を説明します。これらのメソッドを定義すると、<code>new</code>をオーバーライドしなくてもオブジェクトの生成プロセスに割り込むことができます。</p>
<p><code>BUILDARGS</code>メソッドが呼ばれるのはオブジェクトが生成される「前」です。これはクラスメソッドとして呼ばれ、<code>new</code>メソッドに渡されるすべてのパラメータを受け取ります。<code>BUILDARGS</code>メソッドはその引数に何らかの処理をして、ハッシュリファレンスを返すことが期待されています。ハッシュの各キーはアトリビュートの<code>init_arg</code>でなければなりません。</p>
<p><code>BUILDARGS</code>の主な目的は、クラスが名前付き引数以外のものを受け取れるようにすることです。この<code>Person</code>クラスの場合は引数が社会保障番号ひとつだけでも呼べるようにしています。</p>
<pre>  my $person = Person-&gt;new('123-45-6789');

</pre>
<p>今回の<code>BUILDARGS</code>のポイントはこの条件文です。</p>
<pre>      if ( @_ == 1 &amp;&amp; ! ref $_[0] ) {
          return { ssn =&gt; $_[0] };
      }

</pre>
<p>Mooseのコンストラクタは、デフォルトではキーと値のペアからなるリストか、ハッシュリファレンスを受け取るようになっているので、リファレンスでないことを確認してからでないと<code>$_[0]</code>が社会保障番号であると想定することはできません。</p>
<p><code>$class-&gt;SUPER::BUILDARGS(@_)</code>を呼んでいるのは、それ以外のすべてのケースに対応するためです。自分で<code>BUILDARGS</code>メソッドを実装する場合はかならずこのようにしておいてください。<cite>Moose::Object</cite>にもハッシュリファレンスやキーと値のペアのリストを処理する独自の<code>BUILDARGS</code>メソッドが用意されているためです。</p>
<p><code>BUILD</code>メソッドが呼ばれるのはオブジェクトが生成された「あと」、呼び出し元にオブジェクトを返す前です。<code>BUILD</code>メソッドを使うと全体的なオブジェクトの状態をチェックできます。<code>BUILD</code>メソッドは個々のアトリビュートの型制約だけでは表現できないロジックを入れておくのに便利です。</p>
<p><code>Person</code>クラスの場合は<code>ssn</code>と<code>country_of_residence</code>という2つのアトリビュートの関係をチェックする必要があります。オブジェクトが論理的に首尾一貫していない場合は例外が発生します。</p>

</div>
<h2 id="-4">検討課題</h2>
<div id="CONTENT-4">
<p>このレシピではすべてのアトリビュートが読み取り専用なのでかなり単純になっていますが、<code>country_of_residence</code>アトリビュートが設定可能だったら、新しい居住国が<code>usa</code>だったときに<code>ssn</code>が設定されているかチェックする必要が出てきます（このようなチェックは<code>before</code>モディファイアを使えば実現できるかもしれません）。</p>

</div>
<h2 id="-5">まとめ</h2>
<div id="CONTENT-5">
<p>これまで何度もMooseのクラスでは<code>new</code>をオーバーライドしないようにと言ってきました。このレシピでは、<code>new</code>をオーバーライドしなくても<code>BUILDARGS</code>と<code>BUILD</code>を使えばオブジェクトの生成に割り込めることを紹介しました。</p>
<p><code>BUILDARGS</code>メソッドを使うと、Mooseに組み込まれているコンストラクタのパラメータ処理を拡張できます。<code>BUILD</code>メソッドを使うと、オブジェクト生成後にオブジェクト全体にかかわる論理的な制約を実装できます。</p>

</div>
<h2 id="-6">作者</h2>
<div id="CONTENT-6">
<p>Dave Rolsky &lt;autarch@urth.org&gt;</p>

</div>
<h2 id="COPYRIGHT_AND_LICENSE">COPYRIGHT AND LICENSE</h2>
<div id="COPYRIGHT_AND_LICENSE_CONTENT">
<p>Copyright 2006-2009 by Infinity Interactive, Inc.</p>
<p><a href="http://www.iinteractive.com">http://www.iinteractive.com</a></p>
<p>This library is free software; you can redistribute it and/or modify
it under the same terms as Perl itself.</p>

</div>
</div>
<div class="head">
	<div class="logo">
	<img src="http://lazy-css.org/css/img/logo.png">
	</div>
	<ul class="global-navi">

	<li><img src="http://lazy-css.org/css/img/g_home.png" alt="ホーム"></li>
	<li><img src="http://lazy-css.org/css/img/g_news.png" alt="ニュース"></li>
	<li><img src="http://lazy-css.org/css/img/g_blog.png" alt="ブログ"></li>
	</ul>
</div>
<ul class="sub-navi">
<li><img src="http://lazy-css.org/css/img/inq.png" alt="お問い合わせ"></li>
</ul>

<div class="footer">
<ul class="footer-navi">
	<li>リンク</li>
	<li>リンク</li>
	<li>リンク</li>
	<li>リンク</li>
</ul>
<address>&copy; copyright 2009 jpa all right reserved.</address>
</div>
</body>
</html>

